{% extends "base.html" %} {% block content %}
<h1 class="page-title">New Maintenance Log</h1>

<form method="post" class="formbox">
  {% csrf_token %}

  <!-- Equipment Section -->
  <div class="fieldset">
    <h3 style="margin: 0 0 8px 0">
      Equipment
      <button
        type="button"
        onclick="toggleEquipmentForm()"
        class="btn btn-link"
        style="font-size: 0.9em"
      >
        + Add New
      </button>
    </h3>

    <div class="form-group">
      <label for="{{ form.equipment.id_for_label }}">Select Equipment:</label>
      {{ form.equipment }}
    </div>

    <!-- Quick Add Equipment Form (hidden by default) -->
    <div
      id="quick-equipment-form"
      style="
        display: none;
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        background: #f9f9f9;
      "
    >
      <h4 style="margin: 0 0 10px 0">Quick Add Equipment</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
        <div>
          <label>Name:</label>
          <input
            type="text"
            id="new-equipment-name"
            placeholder="Equipment name"
            style="width: 100%"
          />
        </div>
        <div>
          <label>Zone:</label>
          <input
            type="number"
            id="new-equipment-zone"
            min="1"
            max="22"
            value="1"
            style="width: 100%"
          />
        </div>
      </div>
      <div style="margin-top: 10px">
        <button
          type="button"
          onclick="saveQuickEquipment()"
          class="btn btn-primary"
        >
          Add Equipment
        </button>
        <button type="button" onclick="toggleEquipmentForm()" class="btn">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <div class="fieldset">
    <h3 style="margin: 0 0 8px 0">Log Details</h3>

    <div class="form-group">
      <label for="{{ form.zone.id_for_label }}">Zone:</label>
      {{ form.zone }}
    </div>

    <div class="form-group">
      <label for="{{ form.alarm_code.id_for_label }}">Alarm Code:</label>
      {{ form.alarm_code }}
    </div>

    <div class="form-group">
      <label for="{{ form.alarm_name.id_for_label }}">Alarm Name:</label>
      {{ form.alarm_name }}
    </div>

    <div class="form-group">
      <label for="{{ form.difficulty.id_for_label }}">Difficulty:</label>
      {{ form.difficulty }}
    </div>

    <div class="form-group">
      <label for="{{ form.lam_checked.id_for_label }}">LAM Checked:</label>
      {{ form.lam_checked }}
    </div>

    <div class="form-group">
      <label for="{{ form.description.id_for_label }}">Description:</label>
      {{ form.description }}
    </div>
  </div>

  <div class="fieldset">
    <h3 style="margin: 0 0 8px 0">Steps</h3>
    {{ formset.management_form }} {% for f in formset %}
    <div class="step">{{ f.as_p }}</div>
    {% endfor %}
  </div>

  <div>
    <button class="btn btn-primary" type="submit">Save Log</button>
    <a class="btn" href="{% url 'maintenance:log_list' %}">Cancel</a>
  </div>
</form>

<script>
  function toggleEquipmentForm() {
    const form = document.getElementById("quick-equipment-form");
    form.style.display = form.style.display === "none" ? "block" : "none";
  }

  async function saveQuickEquipment() {
    const name = document.getElementById("new-equipment-name").value.trim();
    const zone = document.getElementById("new-equipment-zone").value;

    if (!name) {
      alert("Please enter equipment name");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("name", name);
      formData.append("zone", zone);

      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      const response = await fetch('{% url "maintenance:add_equipment" %}', {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
        },
        body: formData,
      });

      if (response.ok) {
        const equipment = await response.json();

        // Add new option to select
        const select = document.getElementById(
          "{{ form.equipment.id_for_label }}"
        );
        const option = new Option(equipment.name, equipment.id);
        select.add(option);
        select.value = equipment.id;

        // Clear form and hide it
        document.getElementById("new-equipment-name").value = "";
        document.getElementById("new-equipment-zone").value = "1";
        toggleEquipmentForm();

        alert("Equipment added successfully!");
      } else {
        const error = await response.json();
        alert("Error: " + (error.error || "Failed to add equipment"));
      }
    } catch (error) {
      console.error("Error:", error);
      alert("Error adding equipment. Please try again.");
    }
  }
</script>
{% endblock %}
